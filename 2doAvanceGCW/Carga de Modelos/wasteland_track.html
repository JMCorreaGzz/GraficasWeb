<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      body {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <button id="button-login">Login Google</button>
    <button id="button-logout">Logout</button>

    <script type="module">

      import * as THREE from './js/three.module.js';
      import { OrbitControls } from "./js/OrbitControls.js";
      import { GLTFLoader } from "./js/GLTFLoader.js";
      import { STLLoader } from "./js/STLLoader.js";
      //import {FBXLoader} from "./FBXLoader.js";
      import {OBJLoader} from "./js/OBJLoader.js";
      //import {MTLLoader} from "./MTLLoader.js";

      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-app.js";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        onValue,
        set,
      } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-database.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyD3femtx5cdAxoqups15m_2YEOqWfoP1kY",
        authDomain: "pia-gcw.firebaseapp.com",
        databaseURL: "https://pia-gcw-default-rtdb.firebaseio.com",
        projectId: "pia-gcw",
        storageBucket: "pia-gcw.appspot.com",
        messagingSenderId: "41032725572",
        appId: "1:41032725572:web:5cf1b445663bfbc02db811",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth();
      auth.languageCode = "es";
      const provider = new GoogleAuthProvider();
      let theBeast;
      let taxi;
      let tesla;

      let currentUser;
      async function login() {
        await signInWithPopup(auth, provider)
          .then((result) => {
            // This gives you a Google Access Token. You can use it to access the Google API.
            const credential = GoogleAuthProvider.credentialFromResult(result);
            const token = credential.accessToken;
            // The signed-in user info.
            currentUser = result.user;
            var mainModel = 0;
            if (!theBeast) {
              mainModel = 1;
            } else if (!taxi) {
              mainModel = 2;
            } else if (!tesla) {
              mainModel = 3;
            }
            if (mainModel != 0) {
              writeUserData(currentUser.uid, { x: 0, z: 0 }, mainModel);
            }
            console.log(currentUser);
            // ...
          })
          .catch((error) => {
            // Handle Errors here.
            const errorCode = error.code;
            const errorMessage = error.message;
            // The email of the user's account used.
            const email = error.customData.email;
            // The AuthCredential type that was used.
            const credential = GoogleAuthProvider.credentialFromError(error);
            // ...
            console.error("error");
          });
      }

      const buttonLogin = document.getElementById("button-login");
      const buttonLogout = document.getElementById("button-logout");
      buttonLogin.addEventListener("click", async (e) => {
        const user = await login();
      });
      buttonLogout.addEventListener("click", async (e) => {
        await signOut(auth)
          .then(() => {
            // Sign-out successful.
            console.log("Sign-out successful");
          })
          .catch((error) => {
            // An error happened.
            console.log("An error happened");
          });
      });

      // SCENE
      const scene = new THREE.Scene();
      scene.background = new THREE.Color("#34495E");

      const camera = new THREE.PerspectiveCamera(
        60,
        window.innerWidth / window.innerHeight
      );

      camera.position.set(20, 20, 10);

      // RENDERER
      const renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      document.body.appendChild(renderer.domElement);

      // Lights
      const hemispherelight = new THREE.HemisphereLight(0xffffbb, 0x080820, 1);
      //scene.add(hemispherelight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(1, 5, -1);
      directionalLight.castShadow = true;

      const cube1Geometry = new THREE.BoxGeometry(1, 1, 1);
      const cube1Material = new THREE.MeshPhongMaterial({ color: "aqua" });
      const cube1 = new THREE.Mesh(cube1Geometry, cube1Material);
      cube1.castShadow = true;
      cube1.position.set(3, 0, 0);

      let cube1BB = new THREE.Box3();
      cube1BB.setFromObject(cube1);
      //console.log(cube1BB);

      // const bb = new THREE.BoxGeometry(1.5, 1.5, 1.5);
      // const object = new THREE.Mesh(bb, new THREE.MeshBasicMaterial(0xff0000));
      // object.position.set(3, 0, 0);
      // const box = new THREE.BoxHelper(object, 0xff0000);

      const cube2Geometry = new THREE.BoxGeometry(1, 1, 1);
      const cube2Material = new THREE.MeshPhongMaterial({ color: "coral" });
      const cube2 = new THREE.Mesh(cube2Geometry, cube2Material);
      cube2.position.set(-3, 0, 0);
      cube2.castShadow = true;
      //cube2.receiveShadow = true;

      let cube2BB = new THREE.Box3();
      cube2BB.setFromObject(cube2);

      /**
      const sphereGeometry = new THREE.SphereGeometry(1);
      const sphereMaterial = new THREE.MeshPhongMaterial({ color: "teal" });
      const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
      sphere.castShadow = true;
      sphere.position.set(0, 0, 0);
      let sphereBB = new THREE.Sphere(sphere.position, 1);
      **/
      
      // Plane 

      
      const planeGeometry = new THREE.PlaneGeometry(256, 256);
      const loader = new THREE.TextureLoader();

      const height = loader.load('track2.png');
      const track = loader.load('wasteLand.jpg');
      const planeMaterial = new THREE.MeshStandardMaterial({ 
        map: track,
        displacementMap : height
    
      });

      const plane = new THREE.Mesh(planeGeometry, planeMaterial);
      plane.position.set(0, -0.5, 0);
      plane.receiveShadow = true;
      plane.rotateX(-Math.PI / 2);

      // Adding to scene
      scene.add(plane, hemispherelight, directionalLight);

       let theBeastReference;  
      const loaderGLTF = new GLTFLoader();
      loaderGLTF.load("Models/theBeast.glb", function (gltf) {
          let theBeast = gltf.scene;
          theBeastReference = theBeast;
          theBeast.scale.set(2.5, 2.5, 2.5);
          theBeast.position.set(85,0,55);
          theBeast.rotation.y= 3.14159;
          scene.add(theBeast);
        }
      );
      
        let taxiReference;
      loaderGLTF.load("Models/taxi.glb", function (gltf) {
          let taxi = gltf.scene;
          taxiReference = taxi;
          taxi.scale.set(1.0, 1.0, 1.0);
          taxi.position.set(92.5, 0, 55);
          taxi.rotation.y= 3.14159;
          scene.add(taxi);

        
        }
      );
        let teslaReference;
      loaderGLTF.load("Models/teslaTruck.glb", function (gltf) {
          let tesla = gltf.scene;
          teslaReference = tesla;
          tesla.scale.set(1.5, 1.5, 1.5);
          tesla.position.set(100, 3.5, 55);
          tesla.rotation.y=3.14159;
          scene.add(tesla);
          
        
        }
        
      );

      let followCam = new THREE.Object3D();
      followCam.position.copy(camera.position);
      scene.add(followCam);

      loaderGLTF.load("Models/streetlamp.glb", function (gltf) {    //streetlamp 1
        let streetlamp = gltf.scene;
        streetlamp.scale.set(0.1,0.2,0.1);
        streetlamp.rotation.y = 90;
        streetlamp.position.set(10, 0, -115);
        scene.add(streetlamp);
      });

      loaderGLTF.load("Models/streetlamp.glb", function (gltf) {    //streetlamp 2
        let streetlamp = gltf.scene;
        streetlamp.scale.set(0.1,0.2,0.1);
        streetlamp.rotation.y = 0;
        streetlamp.position.set(10, 0, 110);
        scene.add(streetlamp);
      });

      loaderGLTF.load("Models/streetlamp.glb", function (gltf) {    //streetlamp 3
        let streetlamp = gltf.scene;
        streetlamp.scale.set(0.1,0.2,0.1);
        streetlamp.rotation.y = 90;
        streetlamp.position.set(115, 0, 0);
        scene.add(streetlamp);
      });

      loaderGLTF.load("Models/streetlamp.glb", function (gltf) {    //streetlamp 4
        let streetlamp = gltf.scene;
        streetlamp.scale.set(0.1,0.2,0.1);
        streetlamp.rotation.y = 225;
        streetlamp.position.set(-115, 0, 0);
        scene.add(streetlamp);
      });

      loaderGLTF.load("Models/barrel.glb", function (gltf) {    //arbol 
        
        let barrel = gltf.scene;
        barrel.scale.set(1.5,1.5,1.5);
        barrel.rotation.y = 0;
        barrel.position.set(-50, 2.5, 30);
        scene.add(barrel);
      });

      loaderGLTF.load("Models/barrel.glb", function (gltf) {    //arbol 
        
        let barrel2 = gltf.scene;
        barrel2.scale.set(1.5,1.5,1.5);
        barrel2.rotation.y = 0;
        barrel2.position.set(-30, 2.5, 20);
        scene.add(barrel2);
      });

      loaderGLTF.load("Models/barrel.glb", function (gltf) {    //arbol 
        
        let barrel3 = gltf.scene;
        barrel3.scale.set(1.5,1.5,1.5);
        barrel3.rotation.y = 0;
        barrel3.position.set(90, 2.5, -110);
        scene.add(barrel3);
      });

      loaderGLTF.load("Models/barrel.glb", function (gltf) {    //arbol 
        
        let barrel = gltf.scene;
        barrel.scale.set(1.5,1.5,1.5);
        barrel.rotation.x = 0;
        barrel.position.set(115, 2.5, -100);
        scene.add(barrel);
      });

      loaderGLTF.load("Models/barrel.glb", function (gltf) {    //arbol 
        
        let barrel2 = gltf.scene;
        barrel2.scale.set(1.5,1.5,1.5);
        barrel2.rotation.x = 1.5708;
        barrel2.position.set(110, 2.5, -120);
        scene.add(barrel2);
      });

      loaderGLTF.load("Models/barrel.glb", function (gltf) {    //arbol 
        
        let barrel3 = gltf.scene;
        barrel3.scale.set(1.5,1.5,1.5);
        barrel3.rotation.x = 1.5708;
        barrel3.position.set(-30, 2.5, 40);
        scene.add(barrel3);
      });

      loaderGLTF.load("Models/stopSign.glb", function (gltf) {    //arbol 4
        let barrier = gltf.scene;
        barrier.scale.set(1.0,1.0,1.0);
        barrier.rotation.y = 0;
        barrier.position.set(75, 0, 45);
        scene.add(barrier);
      });

     

      loaderGLTF.load("Models/cone2.glb", function (gltf) {    //arbol 5
        let cone = gltf.scene;
        cone.scale.set(1,1,1);
        cone.rotation.y = 0;
        cone.position.set(30, 0.5, 30);
        scene.add(cone);
      });

      loaderGLTF.load("Models/cone2.glb", function (gltf) {    //arbol 5
        let cone = gltf.scene;
        cone.scale.set(1,1,1);
        cone.rotation.y = 0;
        cone.position.set(20, 0.5, 40);
        scene.add(cone);
      });

      loaderGLTF.load("Models/cone2.glb", function (gltf) {    //arbol 5
        let cone = gltf.scene;
        cone.scale.set(1,1,1);
        cone.rotation.y = 0;
        cone.position.set(35, 0.5, 40);
        scene.add(cone);
      });

      
      loaderGLTF.load("Models/cone2.glb", function (gltf) {    //arbol 5
        let cone = gltf.scene;
        cone.scale.set(1,1,1);
        cone.rotation.x = 1.5708;
        cone.position.set(70, 10, -70);
        scene.add(cone);
      });

      loaderGLTF.load("Models/cone2.glb", function (gltf) {    //arbol 5
        let cone = gltf.scene;
        cone.scale.set(1,1,1);
        cone.rotation.y = 0;
        cone.position.set(60, 0.5, -80);
        scene.add(cone);
      });

      loaderGLTF.load("Models/cone2.glb", function (gltf) {    //arbol 5
        let cone = gltf.scene;
        cone.scale.set(1,1,1);
        cone.rotation.y = 0;
        cone.position.set(50, 0.5, -80);
        scene.add(cone);
      });

      loaderGLTF.load("Models/cone2.glb", function (gltf) {    //arbol 5
        let cone = gltf.scene;
        cone.scale.set(1,1,1);
        cone.rotation.x = 1.5708;
        cone.position.set(40, 10, -70);
        scene.add(cone);
      });

      loaderGLTF.load("Models/cone2.glb", function (gltf) {    //arbol 5
        let cone = gltf.scene;
        cone.scale.set(1,1,1);
        cone.rotation.y = 0;
        cone.position.set(30, 0.5, -80);
        scene.add(cone);
      });

      loaderGLTF.load("Models/cone2.glb", function (gltf) {    //arbol 5
        let cone = gltf.scene;
        cone.scale.set(1,1,1);
        cone.rotation.y = 0;
        cone.position.set(20, 0.5, -80);
        scene.add(cone);
      });
      loaderGLTF.load("Models/cone2.glb", function (gltf) {    //arbol 5
        let cone = gltf.scene;
        cone.scale.set(1,1,1);
        cone.rotation.x = 1.5708;
        cone.position.set(10, 10, -70);
        scene.add(cone);
      });
      
      loaderGLTF.load("Models/cone2.glb", function (gltf) {    //arbol 5
        let cone = gltf.scene;
        cone.scale.set(1,1,1);
        cone.rotation.y = 0;
        cone.position.set(0, 0.5, -80);
        scene.add(cone);
      });

      loaderGLTF.load("Models/cone2.glb", function (gltf) {    //arbol 5
        let cone = gltf.scene;
        cone.scale.set(1,1,1);
        cone.rotation.x = 1.5708;
        cone.position.set(-10, 10.0, -70);
        scene.add(cone);
      });

      loaderGLTF.load("Models/barrier.glb", function (gltf) {    //streetlamp 1
        let barrier = gltf.scene;
        barrier.scale.set(5.0,5.0,5.0);
        barrier.position.set(-10, 0, 10);
        barrier.rotation.y= 90;
        scene.add(barrier);
      });

      loaderGLTF.load("Models/barrier.glb", function (gltf) {    //streetlamp 1
        let barrier = gltf.scene;
        barrier.scale.set(5.0,5.0,5.0);
        barrier.position.set(-100, 0, 100);
        barrier.rotation.y= 90;
        scene.add(barrier);
      });

      loaderGLTF.load("Models/barrier.glb", function (gltf) {    //streetlamp 1
        let barrier = gltf.scene;
        barrier.scale.set(5.0,5.0,5.0);
        barrier.position.set(-60, 0, 100);
        barrier.rotation.y= 90;
        scene.add(barrier);
      });

      loaderGLTF.load("Models/barrier.glb", function (gltf) {    //streetlamp 1
        let barrier = gltf.scene;
        barrier.scale.set(5.0,5.0,5.0);
        barrier.position.set(-90, 0, 60);
        barrier.rotation.y= 90;
        scene.add(barrier);
      });

      loaderGLTF.load("Models/tank.glb", function (gltf) {    //streetlamp 1
        let tank = gltf.scene;
        tank.scale.set(20.0,20.0,20.0);
        tank.position.set(-85, 0, 90);
        tank.rotation.y= 0;
        scene.add(tank);
      });

      //Orientación de los autos
     let orientacion = "";
      let orientacionTaxi = 0;
      //Velocidad
      let vel = 0;
      document.onkeydown = function (e) {
        //La Bestia
        //left
        if (e.keyCode === 37) {
          theBeastReference.rotation.y = 11;
          cube1.rotation.y = 0;
          orientacion = "izq";
        }
        //up
        if (e.keyCode === 38) {
          theBeastReference.rotation.y = 3.2;
          cube1.rotation.y = 4.75;
          orientacion = "arr";
        }
        //right
        if (e.keyCode === 39) {
          theBeastReference.rotation.y = 1.56;
          cube1.rotation.y = 0;
          orientacion = "der";
        }
        //down
        if (e.keyCode === 40) {
          theBeastReference.rotation.y = 0;
          cube1.rotation.y = 4.75;
          orientacion = "aba";
        }

        //taxi
        //left
        if (e.keyCode === 65) {
          taxiReference.rotation.y += Math.PI / 2;
          cube2.rotation.y += Math.PI / 2;
          orientacionTaxi += 90;
          vel = 0.1;
          //a
        }
        //up
        if (e.keyCode === 87) {
          //taxiReference.rotation.y = 3.2;
          //cube2.rotation.y = 4.75;
          //orientacionTaxi = "w";
          vel = 0.1;
        }
        //right
        if (e.keyCode === 68) {
          taxiReference.rotation.y -= Math.PI / 2;
          cube2.rotation.y -= Math.PI / 2;
          orientacionTaxi -= 90;
          vel = 0.1;
          //d
        }
        //down
        if (e.keyCode === 83) {
          taxiReference.rotation.y -= Math.PI;
          cube2.rotation.y -= Math.PI;
          orientacionTaxi -= 180;
          vel = 0.1;
          //s
        }
        //freno
        if (e.keyCode === 70) {
          orientacion = "f";
        }
        if (e.keyCode === 66) {
          //orientacionTaxi = 0;
          vel = 0;
          //b
        }
      };
      const cameraControl = new OrbitControls(camera, renderer.domElement);

      function checkCollisions() {

        /**
        if (cube2BB.intersectsSphere(sphereBB)) {
          sphere.material.wireframe = true;
        } else {
          sphere.material.wireframe = false;
        }
        **/

        if (cube2BB.containsBox(cube1BB)) {
          cube1.scale.y = 3;
        } else {
          cube1.scale.y = 1;
        }

        if (cube2BB.intersectsBox(cube1BB)) {
          cube1.material.color = new THREE.Color("red");
        } else {
          cube1.material.color = new THREE.Color("aqua");
        }
      }

      function movimiento() {
        //The Beast
        if (orientacion == "der") {
          theBeastReference.position.x += vel;
          cube1.position.x += vel;
        }
        if (orientacion == "izq") {
          theBeastReference.position.x -= vel;
          cube1.position.x -= vel;
        }
        if (orientacion == "arr") {
          theBeastReference.position.z -= vel;
          cube1.position.z -= vel;
        }
        if (orientacion == "aba") {
          theBeastReference.position.z += vel;
          cube1.position.z += vel;
        }

        //Taxi
        if (taxiReference) {
          var orientacionTaxiMod = orientacionTaxi % 360;
          if (orientacionTaxiMod == 180 || orientacionTaxiMod == -180) {
            taxiReference.position.x -= vel;
            cube2.position.x -= vel;
          }
          if (orientacionTaxiMod == 0) {
            taxiReference.position.x += vel;
            cube2.position.x += vel;
          }
          if (orientacionTaxiMod == 90 || orientacionTaxiMod == -270) {
            taxiReference.position.z -= vel;
            cube2.position.z -= vel;
          }
          if (orientacionTaxiMod == 270 || orientacionTaxiMod == -90) {
            taxiReference.position.z += vel;
            cube2.position.z += vel;
          }
        }
      }
      // Resize

      function resize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.render(scene, camera);
      }

      window.addEventListener("resize", resize);

      function updateCamera() {
        if (taxiReference) {
          followCam.parent = taxiReference;
          camera.position.lerp(
            followCam.getWorldPosition(new THREE.Vector3()),
            0.01
          );
          camera.lookAt(taxiReference.position);
        }
      }

      const db = getDatabase();
      const starCountRef = ref(db, "jugadores");
      onValue(starCountRef, (snapshot) => {
        const data = snapshot.val();
        //console.log(data);
        Object.entries(data).forEach(([key, value]) => {
          const jugador = scene.getObjectByName(key);
          if (!jugador) {
            if (value.model == 1) {
              let theBeastReference;
              const loaderGLTF = new GLTFLoader();
              loaderGLTF.load("Models/theBeast.glb", function (gltf) {
                let theBeast = gltf.scene;
                theBeastReference = theBeast;
                theBeast.scale.set(2.5, 2.5, 2.5);
                theBeast.position.set(-5, 0, 68);
                theBeast.rotation.y = 1.56;
                scene.add(theBeast);
              });
            } else if (value.model == 2) {
              let taxiReference;
              loaderGLTF.load("Models/taxi.glb", function (gltf) {
                let taxi = gltf.scene;
                taxiReference = taxi;
                taxi.scale.set(1.0, 1.0, 1.0);
                taxi.position.set(-6, 0, 74);
                taxi.rotation.y = 1.56;
                scene.add(taxi);
              });
            }
            //Agregar a la escena
          }
        });
      });

      function animate() {
        cube2BB
          .copy(cube2.geometry.boundingBox)
          .applyMatrix4(cube2.matrixWorld);
        cube1BB
          .copy(cube1.geometry.boundingBox)
          .applyMatrix4(cube1.matrixWorld);
        checkCollisions();
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
        movimiento();
        updateCamera();
      }

      animate();
    </script>
  </body>
</html>