<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      body {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <button id="button-login">Login Google</button>
    <button id="button-logout">Logout</button>

    <script type="module">

      import * as THREE from './js/three.module.js';
      import { OrbitControls } from "./js/OrbitControls.js";
      import { GLTFLoader } from "./js/GLTFLoader.js";
      import { STLLoader } from "./js/STLLoader.js";
      //import {FBXLoader} from "./FBXLoader.js";
      import {OBJLoader} from "./js/OBJLoader.js";
      //import {MTLLoader} from "./MTLLoader.js";

      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-app.js";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        onValue,
      } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-database.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyD3femtx5cdAxoqups15m_2YEOqWfoP1kY",
        authDomain: "pia-gcw.firebaseapp.com",
        databaseURL: "https://pia-gcw-default-rtdb.firebaseio.com",
        projectId: "pia-gcw",
        storageBucket: "pia-gcw.appspot.com",
        messagingSenderId: "41032725572",
        appId: "1:41032725572:web:5cf1b445663bfbc02db811",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth();
      auth.languageCode = "es";
      const provider = new GoogleAuthProvider();

      let currentUser;
      async function login() {
        await signInWithPopup(auth, provider)
          .then((result) => {
            // This gives you a Google Access Token. You can use it to access the Google API.
            const credential = GoogleAuthProvider.credentialFromResult(result);
            const token = credential.accessToken;
            // The signed-in user info.
            currentUser = result.user;
            console.log(currentUser);
            // ...
          })
          .catch((error) => {
            // Handle Errors here.
            const errorCode = error.code;
            const errorMessage = error.message;
            // The email of the user's account used.
            const email = error.customData.email;
            // The AuthCredential type that was used.
            const credential = GoogleAuthProvider.credentialFromError(error);
            // ...
            console.error("error");
          });
      }

      const buttonLogin = document.getElementById("button-login");
      const buttonLogout = document.getElementById("button-logout");
      buttonLogin.addEventListener("click", async (e) => {
        const user = await login();
      });
      buttonLogout.addEventListener("click", async (e) => {
        await signOut(auth)
          .then(() => {
            // Sign-out successful.
            console.log("Sign-out successful");
          })
          .catch((error) => {
            // An error happened.
            console.log("An error happened");
          });
      });

      // SCENE
      const scene = new THREE.Scene();
      scene.background = new THREE.Color("#34495E");

      const camera = new THREE.PerspectiveCamera(
        60,
        window.innerWidth / window.innerHeight
      );

      camera.position.set(20, 20, -50);

      // RENDERER
      const renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      document.body.appendChild(renderer.domElement);

      // Lights
      const hemispherelight = new THREE.HemisphereLight(0xffffbb, 0x080820, 1);
      //scene.add(hemispherelight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(1, 5, -1);
      directionalLight.castShadow = true;

      //----------------------------Cubos para hacer las colisiones------------------------------
      //Cubo1(theBeast)
      const cube1Geometry = new THREE.BoxGeometry(10, 3, 5);
      const cube1Material = new THREE.MeshPhongMaterial({
        color: "aqua",
        wireframe: true,
      });
      const cube1 = new THREE.Mesh(cube1Geometry, cube1Material);
      cube1.castShadow = true;
      cube1.position.set(-5, 2, 68);

      //Cubo1(taxi)
      const cube2Geometry = new THREE.BoxGeometry(11, 3, 4);
      const cube2Material = new THREE.MeshPhongMaterial({
        color: "coral",
        wireframe: true,
      });
      const cube2 = new THREE.Mesh(cube2Geometry, cube2Material);
      cube2.position.set(-6, 2, 74);
      cube2.castShadow = true;

      //----------------------------Colisiones------------------------------
      //Cubo1(theBeast)
      let cube1BB = new THREE.Box3();
      cube1BB.setFromObject(cube1);

      //Cubo1(theBeast)
      let cube2BB = new THREE.Box3();
      cube2BB.setFromObject(cube2);

      
      // Plane 

      
      const planeGeometry = new THREE.PlaneGeometry(256, 256);
      const loader = new THREE.TextureLoader();

      const height = loader.load('track2.png');
      const track = loader.load('desertTrack.jpg');
      const planeMaterial = new THREE.MeshStandardMaterial({ 
        map: track,
        displacementMap : height
    
      });

      const plane = new THREE.Mesh(planeGeometry, planeMaterial);
      plane.position.set(0, -0.5, 0);
      plane.receiveShadow = true;
      plane.rotateX(-Math.PI / 2);

      // Adding to scene
      scene.add(plane, hemispherelight, directionalLight);

       let theBeastReference;  
      const loaderGLTF = new GLTFLoader();
      loaderGLTF.load("Models/theBeast.glb", function (gltf) {
          let theBeast = gltf.scene;
          theBeastReference = theBeast;
          theBeast.scale.set(2.5, 2.5, 2.5);
          theBeast.position.set(-5, 0, 100);
          theBeast.rotation.y = 1.56;
          scene.add(theBeast);
        }
      );
      
        let taxiReference;
      loaderGLTF.load("Models/taxi.glb", function (gltf) {
          let taxi = gltf.scene;
          taxiReference = taxi;
          taxi.scale.set(1.0, 1.0, 1.0);
          taxi.position.set(-6, 0, 105);
          taxi.rotation.y = 1.56;
          scene.add(taxi);

        
        }
      );
        let teslaReference;
      loaderGLTF.load("Models/teslaTruck.glb", function (gltf) {
          let tesla = gltf.scene;
          teslaReference = tesla;
          tesla.scale.set(1.5, 1.5, 1.5);
          tesla.position.set(-6, 3.5, 110);
          tesla.rotation.y = 1.56;
          scene.add(tesla);
          
        
        }
        
      );
  
      let followCam = new THREE.Object3D();
      followCam.position.copy(camera.position);
      scene.add(followCam);

      loaderGLTF.load("Models/roca1.glb", function (gltf) {    //arbol 1
        let roca1 = gltf.scene;
        roca1.scale.set(7.0,7.0,7.0);
        roca1.rotation.y = 0;
        roca1.position.set(50, 0, 100);
        scene.add(roca1);
      });

      loaderGLTF.load("Models/roca3.glb", function (gltf) {    //roca 2
        let roca2 = gltf.scene;
        roca2.scale.set(10.0,12.0,10.0);
        roca2.rotation.y = 0;
        roca2.position.set(80, 0, -80);
        scene.add(roca2);
      });

      loaderGLTF.load("Models/roca4.glb", function (gltf) {    //roca 3
        let roca3 = gltf.scene;
        roca3.scale.set(15.0,15.0,15.0);
        roca3.rotation.y = 0;
        roca3.position.set(-150, 0, 100);
        scene.add(roca3);
      });

      loaderGLTF.load("Models/roca5.glb", function (gltf) {    //roca 4
        let roca4 = gltf.scene;
        roca4.scale.set(15.0,20.0,15.0);
        roca4.rotation.y = 0;
        roca4.position.set(-90, 0, 50);
        scene.add(roca4);
      });

      loaderGLTF.load("Models/roca6.glb", function (gltf) {    //roca 5
        let roca5 = gltf.scene;
        roca5.scale.set(20.0,20.0,20.0);
        roca5.rotation.y = 0;
        roca5.position.set(120, 0, 30);
        scene.add(roca5);
      });

      loaderGLTF.load("Models/roca7.glb", function (gltf) {    //roca 6
        let roca6 = gltf.scene;
        roca6.scale.set(10.0,10.0,10.0);
        roca6.rotation.y = 0;
        roca6.position.set(75, 0, -30);
        scene.add(roca6);
      });


      loaderGLTF.load("Models/roca8.glb", function (gltf) {    //roca 7
        let roca7 = gltf.scene;
        roca7.scale.set(15.0,15.0,15.0);
        roca7.rotation.y = 0;
        roca7.position.set(-75, 0, -120);
        scene.add(roca7);
      });

      loaderGLTF.load("Models/roca9.glb", function (gltf) {    //roca 8
        let roca8 = gltf.scene;
        roca8.scale.set(20.0,20.0,20.0);
        roca8.rotation.y = 0;
        roca8.position.set(-80, 0, 80);
        scene.add(roca8);
      });

      loaderGLTF.load("Models/roca10.glb", function (gltf) {    //roca 9
        let roca9 = gltf.scene;
        roca9.scale.set(5.0,5.0,5.0);
        roca9.rotation.y = 0;
        roca9.position.set(40, 0, 30);
        scene.add(roca9);
      });

      loaderGLTF.load("Models/roca6.glb", function (gltf) {    //roca 10
        let roca10 = gltf.scene;
        roca10.scale.set(20.0,20.0,20.0);
        roca10.rotation.y = 0;
        roca10.position.set(150, 0, -80);
        scene.add(roca10);
      });

      loaderGLTF.load("Models/arbol1.glb", function (gltf) {    //arbol 1
        let arbol1 = gltf.scene;
        arbol1.scale.set(5.0,5.0,5.0);
        arbol1.rotation.y = 0;
        arbol1.position.set(90, 0, 30);
        scene.add(arbol1);
      });

      loaderGLTF.load("Models/arbol1.glb", function (gltf) {    //arbol 2
        let arbol2 = gltf.scene;
        arbol2.scale.set(5.0,5.0,5.0);
        arbol2.rotation.y = 0;
        arbol2.position.set(-80, 0, 20);
        scene.add(arbol2);
      });

      loaderGLTF.load("Models/arbol1.glb", function (gltf) {    //arbol 3
        let arbol3 = gltf.scene;
        arbol3.scale.set(5.0,5.0,5.0);
        arbol3.rotation.y = 0;
        arbol3.position.set(40, 0, -100);
        scene.add(arbol3);
      });

     //Orientación de los autos
     let orientacion = "";
      let orientacionTaxi = 0;
      //Velocidad
      let vel = 0;

      document.onkeydown = function (e) {
        //La Bestia
        //left
        if (e.keyCode === 37) {
          theBeastReference.rotation.y = 11;
          cube1.rotation.y = 0;
          orientacion = "izq";
        }
        //up
        if (e.keyCode === 38) {
          theBeastReference.rotation.y = 3.2;
          cube1.rotation.y = 4.75;
          orientacion = "arr";
        }
        //right
        if (e.keyCode === 39) {
          theBeastReference.rotation.y = 1.56;
          cube1.rotation.y = 0;
          orientacion = "der";
        }
        //down
        if (e.keyCode === 40) {
          theBeastReference.rotation.y = 0;
          cube1.rotation.y = 4.75;
          orientacion = "aba";
        }

        //taxi
        //left
        if (e.keyCode === 65) {
          taxiReference.rotation.y += Math.PI / 2;
          cube2.rotation.y += Math.PI / 2;
          orientacionTaxi += 90;
          vel = 0.1;
          //a
        }
        //up
        if (e.keyCode === 87) {
          //taxiReference.rotation.y = 3.2;
          //cube2.rotation.y = 4.75;
          //orientacionTaxi = "w";
          vel = 0.1;
        }
        //right
        if (e.keyCode === 68) {
          taxiReference.rotation.y -= Math.PI / 2;
          cube2.rotation.y -= Math.PI / 2;
          orientacionTaxi -= 90;
          vel = 0.1;
          //d
        }
        //down
        if (e.keyCode === 83) {
          taxiReference.rotation.y -= Math.PI;
          cube2.rotation.y -= Math.PI;
          orientacionTaxi -= 180;
          vel = 0.1;
          //s
        }
        //freno
        if (e.keyCode === 70) {
          orientacion = "f";
        }
        if (e.keyCode === 66) {
          //orientacionTaxi = 0;
          vel = 0;
          //b
        }
      };


      const cameraControl = new OrbitControls(camera, renderer.domElement);

      function checkCollisions() {
        if (cube2BB.intersectsBox(cube1BB)) {
          cube1.material.color = new THREE.Color("red");
        } else {
          cube1.material.color = new THREE.Color("aqua");
        }
      }

      function movimiento() {
        //The Beast
        if (orientacion == "der") {
          theBeastReference.position.x += vel;
          cube1.position.x += vel;
        }
        if (orientacion == "izq") {
          theBeastReference.position.x -= vel;
          cube1.position.x -= vel;
        }
        if (orientacion == "arr") {
          theBeastReference.position.z -= vel;
          cube1.position.z -= vel;
        }
        if (orientacion == "aba") {
          theBeastReference.position.z += vel;
          cube1.position.z += vel;
        }

        //Taxi
        if (taxiReference) {
          var orientacionTaxiMod = orientacionTaxi % 360;
          if (orientacionTaxiMod == 180 || orientacionTaxiMod == -180) {
            taxiReference.position.x -= vel;
            cube2.position.x -= vel;
          }
          if (orientacionTaxiMod == 0) {
            taxiReference.position.x += vel;
            cube2.position.x += vel;
          }
          if (orientacionTaxiMod == 90 || orientacionTaxiMod == -270) {
            taxiReference.position.z -= vel;
            cube2.position.z -= vel;
          }
          if (orientacionTaxiMod == 270 || orientacionTaxiMod == -90) {
            taxiReference.position.z += vel;
            cube2.position.z += vel;
          }
        }
      }
      // Resize

      function resize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.render(scene, camera);
      }

      window.addEventListener("resize", resize);

      function updateCamera() {
        if (taxiReference) {
          followCam.parent = taxiReference;
          camera.position.lerp(
            followCam.getWorldPosition(new THREE.Vector3()),
            0.01
          );
          camera.lookAt(taxiReference.position);
        }
      }

      const db = getDatabase();
      const starCountRef = ref(db, "jugadores");
      onValue(starCountRef, (snapshot) => {
        const data = snapshot.val();
        //console.log(data);
        Object.entries(data).forEach(([key, value]) => {
          const jugador = scene.getObjectByName(key);
          if (!jugador) {
            if (value.model == 1) {
              let theBeastReference;
              const loaderGLTF = new GLTFLoader();
              loaderGLTF.load("Models/theBeast.glb", function (gltf) {
                let theBeast = gltf.scene;
                theBeastReference = theBeast;
                theBeast.scale.set(2.5, 2.5, 2.5);
                theBeast.position.set(-5, 0, 68);
                theBeast.rotation.y = 1.56;
                scene.add(theBeast);
              });
            } else if (value.model == 2) {
              let taxiReference;
              loaderGLTF.load("Models/taxi.glb", function (gltf) {
                let taxi = gltf.scene;
                taxiReference = taxi;
                taxi.scale.set(1.0, 1.0, 1.0);
                taxi.position.set(-6, 0, 74);
                taxi.rotation.y = 1.56;
                scene.add(taxi);
              });
            }
            //Agregar a la escena
          }
        });
      });

      function animate() {
        cube2BB
          .copy(cube2.geometry.boundingBox)
          .applyMatrix4(cube2.matrixWorld);
        cube1BB
          .copy(cube1.geometry.boundingBox)
          .applyMatrix4(cube1.matrixWorld);
        checkCollisions();
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
        movimiento();
        updateCamera();
      }

      animate();
    </script>
  </body>
</html>