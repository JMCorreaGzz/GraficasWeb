<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      body {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <script type="module">

      import * as THREE from './js/three.module.js';
      import { OrbitControls } from "./js/OrbitControls.js";
      import { GLTFLoader } from "./js/GLTFLoader.js";
      import { STLLoader } from "./js/STLLoader.js";
      //import {FBXLoader} from "./FBXLoader.js";
      import {OBJLoader} from "./js/OBJLoader.js";
      //import {MTLLoader} from "./MTLLoader.js";

      // SCENE
      const scene = new THREE.Scene();
      scene.background = new THREE.Color("#34495E");

      const camera = new THREE.PerspectiveCamera(
        60,
        window.innerWidth / window.innerHeight
      );

      camera.position.set(0, 10, -20);

      // RENDERER
      const renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      document.body.appendChild(renderer.domElement);

      // Lights
      const hemispherelight = new THREE.HemisphereLight(0xffffbb, 0x080820, 1);
      //scene.add(hemispherelight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(1, 5, -1);
      directionalLight.castShadow = true;

      //----------------------------Cubos para hacer las colisiones------------------------------
      //Cubo1(theBeast)
      const cube1Geometry = new THREE.BoxGeometry(10, 3, 5);
      const cube1Material = new THREE.MeshPhongMaterial({ color: "aqua", wireframe: true});
      const cube1 = new THREE.Mesh(cube1Geometry, cube1Material);
      cube1.castShadow = true;
      cube1.position.set(-5, 2, 68);

      //Cubo1(taxi)
      const cube2Geometry = new THREE.BoxGeometry(11, 3, 4);
      const cube2Material = new THREE.MeshPhongMaterial({ color: "coral", wireframe: true});
      const cube2 = new THREE.Mesh(cube2Geometry, cube2Material);
      cube2.position.set(-6, 2, 74);
      cube2.castShadow = true;

      //----------------------------Colisiones------------------------------
      //Cubo1(theBeast)
      let cube1BB = new THREE.Box3();
      cube1BB.setFromObject(cube1);

      //Cubo1(theBeast)
      let cube2BB = new THREE.Box3();
      cube2BB.setFromObject(cube2);

      //---------------------------------------------------------------------
      // Plane 
      const planeGeometry = new THREE.PlaneGeometry(256, 256);
      const loader = new THREE.TextureLoader();

      const height = loader.load('track2.png');
      const track = loader.load('circuit.jpg');
      const planeMaterial = new THREE.MeshStandardMaterial({ 
        map: track,
        displacementMap : height
    
      });

      const plane = new THREE.Mesh(planeGeometry, planeMaterial);
      plane.position.set(0, -0.5, 0);
      plane.receiveShadow = true;
      plane.rotateX(-Math.PI / 2);

      // Adding to scene
      scene.add(cube1, cube2, plane, hemispherelight, directionalLight);

       let theBeastReference;  
      const loaderGLTF = new GLTFLoader();
      loaderGLTF.load("Models/theBeast.glb", function (gltf) {
          let theBeast = gltf.scene;
          theBeastReference = theBeast;
          theBeast.scale.set(2.5, 2.5, 2.5);
          theBeast.position.set(-5, 0, 68);
          theBeast.rotation.y = 1.56;
          scene.add(theBeast);
        }
      );

        let taxiReference;
      loaderGLTF.load("Models/taxi.glb", function (gltf) {
          let taxi = gltf.scene;
          taxiReference = taxi;
          taxi.scale.set(1.0, 1.0, 1.0);
          taxi.position.set(-6, 0, 74);
          taxi.rotation.y = 1.56;
          scene.add(taxi);

        
        }
      );
        let teslaReference;
      loaderGLTF.load("Models/teslaTruck.glb", function (gltf) {
          let tesla = gltf.scene;
          teslaReference = tesla;
          tesla.scale.set(1.5, 1.5, 1.5);
          tesla.position.set(-6, 3.5, 80);
          tesla.rotation.y = 1.56;
          scene.add(tesla);
          
        
        }
        
      );

      let followCam = new THREE.Object3D();
		  followCam.position.copy(camera.position);
		  scene.add(followCam);
      if(theBeastReference){
		    
      }

      loaderGLTF.load("Models/streetlamp.glb", function (gltf) {    //streetlamp 1
        let streetlamp = gltf.scene;
        streetlamp.scale.set(0.1,0.2,0.1);
        streetlamp.position.set(10, 0, -60);
        scene.add(streetlamp);
      });

      loaderGLTF.load("Models/streetlamp.glb", function (gltf) {    //streetlamp 2
        let streetlamp = gltf.scene;
        streetlamp.scale.set(0.1,0.2,0.1);
        streetlamp.rotation.y = 135;
        streetlamp.position.set(10, 0, 60);
        scene.add(streetlamp);
      });

      loaderGLTF.load("Models/streetlamp.glb", function (gltf) {    //streetlamp 3
        let streetlamp = gltf.scene;
        streetlamp.scale.set(0.1,0.2,0.1);
        streetlamp.rotation.y = 225;
        streetlamp.position.set(75, 0, 0);
        scene.add(streetlamp);
      });

      loaderGLTF.load("Models/streetlamp.glb", function (gltf) {    //streetlamp 4
        let streetlamp = gltf.scene;
        streetlamp.scale.set(0.1,0.2,0.1);
        streetlamp.rotation.y = -225;
        streetlamp.position.set(-75, 0, 0);
        scene.add(streetlamp);
      });

      loaderGLTF.load("Models/arbol1.glb", function (gltf) {    //arbol 1
        let arbol1 = gltf.scene;
        arbol1.scale.set(7.0,7.0,7.0);
        arbol1.rotation.y = 0;
        arbol1.position.set(50, 0, 100);
        scene.add(arbol1);
      });

      loaderGLTF.load("Models/arbol2.glb", function (gltf) {    //arbol 2
        let arbol2 = gltf.scene;
        arbol2.scale.set(4.0,6.0,4.0);
        arbol2.rotation.y = 0;
        arbol2.position.set(-70, 0, -50);
        scene.add(arbol2);
      });

      loaderGLTF.load("Models/arbol3.glb", function (gltf) {    //arbol 3
        let arbol3 = gltf.scene;
        arbol3.scale.set(5.0,5.0,5.0);
        arbol3.rotation.y = 0;
        arbol3.position.set(60, 0, -100);
        scene.add(arbol3);
      });

      loaderGLTF.load("Models/arbol4.glb", function (gltf) {    //arbol 4
        let arbol4 = gltf.scene;
        arbol4.scale.set(15.0,20.0,15.0);
        arbol4.rotation.y = 0;
        arbol4.position.set(130, 12, 35);
        scene.add(arbol4);
      });

      loaderGLTF.load("Models/arbol5.glb", function (gltf) {    //arbol 5
        let arbol5 = gltf.scene;
        arbol5.scale.set(10.0,10.0,10.0);
        arbol5.rotation.y = 0;
        arbol5.position.set(-70, 0, 30);
        scene.add(arbol5);
      });

      loaderGLTF.load("Models/arbol6.glb", function (gltf) {    //arbol 6
        let arbol6 = gltf.scene;
        arbol6.scale.set(10.0,10.0,10.0);
        arbol6.rotation.y = 0;
        arbol6.position.set(75, 6.4, -30);
        scene.add(arbol6);
      });


      loaderGLTF.load("Models/arbol7.glb", function (gltf) {    //arbol 7
        let arbol7 = gltf.scene;
        arbol7.scale.set(15.0,15.0,15.0);
        arbol7.rotation.y = 0;
        arbol7.position.set(-50, 9, -100);
        scene.add(arbol7);
      });

      loaderGLTF.load("Models/arbol8.glb", function (gltf) {    //arbol 8
        let arbol8 = gltf.scene;
        arbol8.scale.set(14.0,14.0,14.0);
        arbol8.rotation.y = 0;
        arbol8.position.set(-80, 8, 100);
        scene.add(arbol8);
      });

      loaderGLTF.load("Models/arbol9.glb", function (gltf) {    //arbol 9
        let arbol9 = gltf.scene;
        arbol9.scale.set(10.0,10.0,10.0);
        arbol9.rotation.y = 0;
        arbol9.position.set(30, 6, 30);
        scene.add(arbol9);
      });

      loaderGLTF.load("Models/arbol10.glb", function (gltf) {    //arbol 10
        let arbol9 = gltf.scene;
        arbol9.scale.set(10.0,10.0,10.0);
        arbol9.rotation.y = 0;
        arbol9.position.set(90, 5.5, -80);
        scene.add(arbol9);
      });


        //Orientaci√≥n de los autos
        let orientacion = "";
        let orientacionTaxi = "";
        //Velocidad
        let vel = 0.1;


     document.onkeydown = function (e) {
       
        //La Bestia
        //left
        if (e.keyCode === 37) {
   
          theBeastReference.rotation.y = 11;
          cube1.rotation.y = 0;
          orientacion = "izq";
        }
        //up
        if (e.keyCode === 38) {

          theBeastReference.rotation.y = 3.2;
          cube1.rotation.y = 4.75;
          orientacion = "arr";

        }
        //right
        if (e.keyCode === 39) {
          theBeastReference.rotation.y = 1.56;
          cube1.rotation.y = 0;
          orientacion = "der";
        }
        //down
        if (e.keyCode === 40) {
          theBeastReference.rotation.y = 0;
          cube1.rotation.y = 4.75;
          orientacion = "aba";
        }

          //taxi
        //left
        if (e.keyCode === 65) {

          taxiReference.rotation.y = 11;
          cube2.rotation.y = 0;
          orientacionTaxi = "a";

        }
        //up
        if (e.keyCode === 87) {
    
          taxiReference.rotation.y = 3.2;
          cube2.rotation.y = 4.75;
          orientacionTaxi = "w";


        }
        //right
        if (e.keyCode === 68) {

          taxiReference.rotation.y = 1.56;
          cube2.rotation.y = 0;
          orientacionTaxi = "d"

        }
        //down
        if (e.keyCode === 83) {
          
          taxiReference.rotation.y = 0;
          cube2.rotation.y = 4.75;
          orientacionTaxi = "s";


        }
        //freno
        if(e.keyCode === 70){
          orientacion = "f";
        }
        if(e.keyCode === 66){
          orientacionTaxi = "b";
        }

      };

      const cameraControl = new OrbitControls(camera, renderer.domElement);

      function checkCollisions() {

        if (cube2BB.intersectsBox(cube1BB)) {
          cube1.material.color = new THREE.Color("red");
        } else {
          cube1.material.color = new THREE.Color("aqua");
        }
        
      }

      function movimiento(){
        //The Beast
        if(orientacion == "der"){

          theBeastReference.position.x += vel;
          cube1.position.x += vel;

        }if(orientacion == "izq"){
          theBeastReference.position.x -= vel;
          cube1.position.x -= vel;

        }if(orientacion == "arr"){

          theBeastReference.position.z -= vel;
          cube1.position.z -= vel;
          
        }if(orientacion == "aba"){

          theBeastReference.position.z += vel;
          cube1.position.z += vel;
        }

        //Taxi
        if(orientacionTaxi == "d"){

          taxiReference.position.x += vel;
          cube2.position.x += vel;

        }if(orientacionTaxi == "a"){

          taxiReference.position.x -= vel;
          cube2.position.x -= vel;

        }if(orientacionTaxi == "w"){

          taxiReference.position.z -= vel;
          cube2.position.z -= vel;

        }if(orientacionTaxi == "s"){

          taxiReference.position.z += vel;
          cube2.position.z += vel;

        }


      }

      // Resize

      function resize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.render(scene, camera);
      }

      window.addEventListener("resize", resize);

      function updateCamera(){
        if(taxiReference){
          followCam.parent = taxiReference;
          camera.position.lerp(followCam.getWorldPosition(new THREE.Vector3()), 0.05);
		      camera.lookAt(taxiReference.position);
        }
      }
    

      function animate() {
        
        cube2BB.copy(cube2.geometry.boundingBox).applyMatrix4(cube2.matrixWorld);
        cube1BB.copy(cube1.geometry.boundingBox).applyMatrix4(cube1.matrixWorld);
        checkCollisions();
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
        movimiento();
        updateCamera();
      }

      animate();
    </script>
  </body>
</html>
