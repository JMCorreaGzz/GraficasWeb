<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      body {
        margin: 0;
      }
    </style>

    <script type="text/javascript">
      function musicOn() {
        var m = localStorage.getItem("musicOn");

        return m;
      }
    </script>
  </head>
  <body>
    <button id="button-login">Login Google</button>
    <button id="button-logout">Logout</button>

    <script type="module">
      import * as THREE from "./js/three.module.js";
      import { OrbitControls } from "./js/OrbitControls.js";
      import { GLTFLoader } from "./js/GLTFLoader.js";
      import { STLLoader } from "./js/STLLoader.js";
      //import {FBXLoader} from "./FBXLoader.js";
      import { OBJLoader } from "./js/OBJLoader.js";
      //import {MTLLoader} from "./MTLLoader.js";

      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-app.js";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        onValue,
        set,
        remove,
      } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-database.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyD3femtx5cdAxoqups15m_2YEOqWfoP1kY",
        authDomain: "pia-gcw.firebaseapp.com",
        databaseURL: "https://pia-gcw-default-rtdb.firebaseio.com",
        projectId: "pia-gcw",
        storageBucket: "pia-gcw.appspot.com",
        messagingSenderId: "41032725572",
        appId: "1:41032725572:web:5cf1b445663bfbc02db811",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth();
      auth.languageCode = "es";
      const provider = new GoogleAuthProvider();
      let theBeast;
      let taxi;
      let tesla;
      var mainModel = 0;
      var url = new URL(window.location.href);
      var level = url.searchParams.get("level");

      let currentUser;
      async function login() {
        await signInWithPopup(auth, provider)
          .then((result) => {
            // This gives you a Google Access Token. You can use it to access the Google API.
            const credential = GoogleAuthProvider.credentialFromResult(result);
            const token = credential.accessToken;
            // The signed-in user info.
            currentUser = result.user;
            if (!theBeast) {
              mainModel = 1;
            } else if (!taxi) {
              mainModel = 2;
            } else if (!tesla) {
              mainModel = 3;
            }
            if (mainModel != 0) {
              let playerPositionX;
              let playerPositionZ;
              if (mainModel == 1) {
                playerPositionX = -5;
                playerPositionZ = 68;
              }
              if (mainModel == 2) {
                playerPositionX = -6;
                playerPositionZ = 74;
              }
              if (mainModel == 3) {
                playerPositionX = -6;
                playerPositionZ = 80;
              }
              writeUserData(
                currentUser.uid,
                { x: playerPositionX, z: playerPositionZ },
                1.56,
                mainModel
              );
            }
            console.log(currentUser);
            // ...
          })
          .catch((error) => {
            // Handle Errors here.
            const errorCode = error.code;
            const errorMessage = error.message;
            // The email of the user's account used.
            //const email = error.customData.email;
            // The AuthCredential type that was used.
            //const credential = GoogleAuthProvider.credentialFromError(error);
            // ...
            console.error("error");
          });
      }

      const buttonLogin = document.getElementById("button-login");
      const buttonLogout = document.getElementById("button-logout");
      buttonLogin.addEventListener("click", async (e) => {
        const user = await login();
      });
      buttonLogout.addEventListener("click", async (e) => {
        await signOut(auth)
          .then(() => {
            // Sign-out successful.
            console.log("Sign-out successful");
          })
          .catch((error) => {
            // An error happened.
            console.log("An error happened");
          });
      });

      // SCENE
      const scene = new THREE.Scene();
      scene.background = new THREE.Color("#34495E");

      const camera = new THREE.PerspectiveCamera(
        60,
        window.innerWidth / window.innerHeight
      );

      camera.position.set(0, 10, -20);

      //MUSIC & SOUNDS
      const listener = new THREE.AudioListener();
      camera.add(listener);

      const audioLoader = new THREE.AudioLoader();
      const starLoader = new THREE.AudioLoader();
      const ballLoader = new THREE.AudioLoader();

      const backgroundSound = new THREE.Audio(listener);
      const starSound = new THREE.Audio(listener);
      const ballSound = new THREE.Audio(listener);

      audioLoader.load(
        "../Carga de Modelos/Sounds/background_music.ogg",
        function (buffer) {
          backgroundSound.setBuffer(buffer);

          backgroundSound.setLoop(true);

          backgroundSound.setVolume(0.1);
        }
      );
      starLoader.load(
        "../Carga de Modelos/Sounds/spell2.wav",
        function (buffer) {
          starSound.setBuffer(buffer);

          starSound.setLoop(false);

          starSound.setVolume(0.5);
        }
      );
      ballLoader.load(
        "../Carga de Modelos/Sounds/pacman_wakka.wav",
        function (buffer) {
          ballSound.setBuffer(buffer);

          ballSound.setLoop(false);

          ballSound.setVolume(0.5);
        }
      );

      // RENDERER
      const renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      document.body.appendChild(renderer.domElement);

      // Lights
      const ambient = new THREE.AmbientLight(0x050505);
      const hemispherelight = new THREE.HemisphereLight(0xffffbb, 0x080820, 1);
      //scene.add(hemispherelight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(1, 5, -1);
      directionalLight.castShadow = true;

      //----------------------------Cubos para hacer las colisiones------------------------------
      //Cubo1(theBeast)
      const cube1Geometry = new THREE.BoxGeometry(10, 3, 5);
      const cube1Material = new THREE.MeshPhongMaterial({
        color: "aqua",
        wireframe: true,
        visible: false,
      });
      const cube1 = new THREE.Mesh(cube1Geometry, cube1Material);
      cube1.castShadow = true;
      cube1.position.set(-5, 2, 68);

      //Cubo2(taxi)
      const cube2Geometry = new THREE.BoxGeometry(11, 3, 4);
      const cube2Material = new THREE.MeshPhongMaterial({
        color: "coral",
        wireframe: true,
        visible: false,
      });
      const cube2 = new THREE.Mesh(cube2Geometry, cube2Material);
      cube2.position.set(-6, 2, 74);
      cube2.castShadow = true;

      //Cubo3(star)
      const cube3Geometry = new THREE.BoxGeometry(3, 3, 3);
      const cube3Material = new THREE.MeshPhongMaterial({
        color: "blue",
        wireframe: true,
        visible: false,
      });
      const cube3 = new THREE.Mesh(cube3Geometry, cube3Material);
      cube3.position.set(90, 4, 0);
      cube3.castShadow = true;

      //Cubo4(ball)
      const cube4Geometry = new THREE.BoxGeometry(3, 3, 3);
      const cube4Material = new THREE.MeshPhongMaterial({
        color: "blue",
        wireframe: true,
        visible: false,
      });
      const cube4 = new THREE.Mesh(cube4Geometry, cube4Material);
      cube4.position.set(95, 4, 40);
      cube4.castShadow = true;

      //----------------------------Colisiones------------------------------
      //Cubo1(theBeast)
      let cube1BB = new THREE.Box3();
      cube1BB.setFromObject(cube1);

      //Cubo1(theBeast)
      let cube2BB = new THREE.Box3();
      cube2BB.setFromObject(cube2);

      //Cubo3(star)
      let cube3BB = new THREE.Box3();
      cube3BB.setFromObject(cube3);

      //Cubo4(ball)
      let cube4BB = new THREE.Box3();
      cube4BB.setFromObject(cube4);

      //---------------------------------------------------------------------

      // Adding to scene
      scene.add(
        cube1,
        cube2,
        cube3,
        cube4,
        ambient,
        hemispherelight,
        directionalLight
      );

      const loaderGLTF = new GLTFLoader();
      /*let theBeastReference;
      const loaderGLTF = new GLTFLoader();
      loaderGLTF.load("Models/theBeast.glb", function (gltf) {
        let theBeast = gltf.scene;
        theBeastReference = theBeast;
        theBeast.scale.set(2.5, 2.5, 2.5);
        theBeast.position.set(-5, 0, 68);
        theBeast.rotation.y = 1.56;
        scene.add(theBeast);
      });

      let taxiReference;
      loaderGLTF.load("Models/taxi.glb", function (gltf) {
        let taxi = gltf.scene;
        taxiReference = taxi;
        taxi.scale.set(1.0, 1.0, 1.0);
        taxi.position.set(-6, 0, 74);
        taxi.rotation.y = 1.56;
        scene.add(taxi);
      });
      let teslaReference;
      loaderGLTF.load("Models/teslaTruck.glb", function (gltf) {
        let tesla = gltf.scene;
        teslaReference = tesla;
        tesla.scale.set(1.5, 1.5, 1.5);
        tesla.position.set(-6, 3.5, 80);
        tesla.rotation.y = 1.56;
        scene.add(tesla);
      });*/

      let followCam = new THREE.Object3D();
      followCam.position.copy(camera.position);
      scene.add(followCam);

      if (level == 1) {
        // Plane
        const planeGeometry = new THREE.PlaneGeometry(256, 256);
        const loader = new THREE.TextureLoader();

        const height = loader.load("track2.png");
        const track = loader.load("circuit.jpg");
        const planeMaterial = new THREE.MeshStandardMaterial({
          map: track,
          displacementMap: height,
        });

        const plane = new THREE.Mesh(planeGeometry, planeMaterial);
        plane.position.set(0, -0.5, 0);
        plane.receiveShadow = true;
        plane.rotateX(-Math.PI / 2);

        // Adding to scene
        scene.add(plane);

        loaderGLTF.load("Models/streetlamp.glb", function (gltf) {
          //streetlamp 1
          let streetlamp = gltf.scene;
          streetlamp.scale.set(0.1, 0.2, 0.1);
          streetlamp.position.set(10, 0, -60);
          scene.add(streetlamp);
        });

        loaderGLTF.load("Models/streetlamp.glb", function (gltf) {
          //streetlamp 2
          let streetlamp = gltf.scene;
          streetlamp.scale.set(0.1, 0.2, 0.1);
          streetlamp.rotation.y = 135;
          streetlamp.position.set(10, 0, 60);
          scene.add(streetlamp);
        });

        loaderGLTF.load("Models/streetlamp.glb", function (gltf) {
          //streetlamp 3
          let streetlamp = gltf.scene;
          streetlamp.scale.set(0.1, 0.2, 0.1);
          streetlamp.rotation.y = 225;
          streetlamp.position.set(75, 0, 0);
          scene.add(streetlamp);
        });

        loaderGLTF.load("Models/streetlamp.glb", function (gltf) {
          //streetlamp 4
          let streetlamp = gltf.scene;
          streetlamp.scale.set(0.1, 0.2, 0.1);
          streetlamp.rotation.y = -225;
          streetlamp.position.set(-75, 0, 0);
          scene.add(streetlamp);
        });

        loaderGLTF.load("Models/arbol1.glb", function (gltf) {
          //arbol 1
          let arbol1 = gltf.scene;
          arbol1.scale.set(7.0, 7.0, 7.0);
          arbol1.rotation.y = 0;
          arbol1.position.set(50, 0, 100);
          scene.add(arbol1);
        });

        loaderGLTF.load("Models/arbol2.glb", function (gltf) {
          //arbol 2
          let arbol2 = gltf.scene;
          arbol2.scale.set(4.0, 6.0, 4.0);
          arbol2.rotation.y = 0;
          arbol2.position.set(-70, 0, -50);
          scene.add(arbol2);
        });

        loaderGLTF.load("Models/arbol3.glb", function (gltf) {
          //arbol 3
          let arbol3 = gltf.scene;
          arbol3.scale.set(5.0, 5.0, 5.0);
          arbol3.rotation.y = 0;
          arbol3.position.set(60, 0, -100);
          scene.add(arbol3);
        });

        loaderGLTF.load("Models/arbol4.glb", function (gltf) {
          //arbol 4
          let arbol4 = gltf.scene;
          arbol4.scale.set(15.0, 20.0, 15.0);
          arbol4.rotation.y = 0;
          arbol4.position.set(130, 12, 35);
          scene.add(arbol4);
        });

        loaderGLTF.load("Models/arbol5.glb", function (gltf) {
          //arbol 5
          let arbol5 = gltf.scene;
          arbol5.scale.set(10.0, 10.0, 10.0);
          arbol5.rotation.y = 0;
          arbol5.position.set(-70, 0, 30);
          scene.add(arbol5);
        });

        loaderGLTF.load("Models/arbol6.glb", function (gltf) {
          //arbol 6
          let arbol6 = gltf.scene;
          arbol6.scale.set(10.0, 10.0, 10.0);
          arbol6.rotation.y = 0;
          arbol6.position.set(75, 6.4, -30);
          scene.add(arbol6);
        });

        loaderGLTF.load("Models/arbol7.glb", function (gltf) {
          //arbol 7
          let arbol7 = gltf.scene;
          arbol7.scale.set(15.0, 15.0, 15.0);
          arbol7.rotation.y = 0;
          arbol7.position.set(-50, 9, -100);
          scene.add(arbol7);
        });

        loaderGLTF.load("Models/arbol8.glb", function (gltf) {
          //arbol 8
          let arbol8 = gltf.scene;
          arbol8.scale.set(14.0, 14.0, 14.0);
          arbol8.rotation.y = 0;
          arbol8.position.set(-80, 8, 100);
          scene.add(arbol8);
        });

        loaderGLTF.load("Models/arbol9.glb", function (gltf) {
          //arbol 9
          let arbol9 = gltf.scene;
          arbol9.scale.set(10.0, 10.0, 10.0);
          arbol9.rotation.y = 0;
          arbol9.position.set(30, 6, 30);
          scene.add(arbol9);
        });

        loaderGLTF.load("Models/arbol10.glb", function (gltf) {
          //arbol 10
          let arbol9 = gltf.scene;
          arbol9.scale.set(10.0, 10.0, 10.0);
          arbol9.rotation.y = 0;
          arbol9.position.set(90, 5.5, -80);
          scene.add(arbol9);
        });
      } else if (level == 2) {
        // Plane

        const planeGeometry = new THREE.PlaneGeometry(256, 256);
        const loader = new THREE.TextureLoader();

        const height = loader.load("track2.png");
        const track = loader.load("desertTrack.jpg");
        const planeMaterial = new THREE.MeshStandardMaterial({
          map: track,
          displacementMap: height,
        });

        const plane = new THREE.Mesh(planeGeometry, planeMaterial);
        plane.position.set(0, -0.5, -29);
        plane.receiveShadow = true;
        plane.rotateX(-Math.PI / 2);

        scene.add(plane);

        loaderGLTF.load("Models/roca1.glb", function (gltf) {
          //arbol 1
          let roca1 = gltf.scene;
          roca1.scale.set(7.0, 7.0, 7.0);
          roca1.rotation.y = 0;
          roca1.position.set(50, 0, 71);
          scene.add(roca1);
        });

        loaderGLTF.load("Models/roca3.glb", function (gltf) {
          //roca 2
          let roca2 = gltf.scene;
          roca2.scale.set(10.0, 12.0, 10.0);
          roca2.rotation.y = 0;
          roca2.position.set(80, 0, -109);
          scene.add(roca2);
        });

        loaderGLTF.load("Models/roca4.glb", function (gltf) {
          //roca 3
          let roca3 = gltf.scene;
          roca3.scale.set(15.0, 15.0, 15.0);
          roca3.rotation.y = 0;
          roca3.position.set(-150, 0, 71);
          scene.add(roca3);
        });

        loaderGLTF.load("Models/roca5.glb", function (gltf) {
          //roca 4
          let roca4 = gltf.scene;
          roca4.scale.set(15.0, 20.0, 15.0);
          roca4.rotation.y = 0;
          roca4.position.set(-90, 0, 21);
          scene.add(roca4);
        });

        loaderGLTF.load("Models/roca6.glb", function (gltf) {
          //roca 5
          let roca5 = gltf.scene;
          roca5.scale.set(20.0, 20.0, 20.0);
          roca5.rotation.y = 0;
          roca5.position.set(120, 0, 1);
          scene.add(roca5);
        });

        loaderGLTF.load("Models/roca7.glb", function (gltf) {
          //roca 6
          let roca6 = gltf.scene;
          roca6.scale.set(10.0, 10.0, 10.0);
          roca6.rotation.y = 0;
          roca6.position.set(75, 0, -59);
          scene.add(roca6);
        });

        loaderGLTF.load("Models/roca8.glb", function (gltf) {
          //roca 7
          let roca7 = gltf.scene;
          roca7.scale.set(15.0, 15.0, 15.0);
          roca7.rotation.y = 0;
          roca7.position.set(-75, 0, -149);
          scene.add(roca7);
        });

        loaderGLTF.load("Models/roca9.glb", function (gltf) {
          //roca 8
          let roca8 = gltf.scene;
          roca8.scale.set(20.0, 20.0, 20.0);
          roca8.rotation.y = 0;
          roca8.position.set(-80, 0, 51);
          scene.add(roca8);
        });

        loaderGLTF.load("Models/roca10.glb", function (gltf) {
          //roca 9
          let roca9 = gltf.scene;
          roca9.scale.set(5.0, 5.0, 5.0);
          roca9.rotation.y = 0;
          roca9.position.set(40, 0, 1);
          scene.add(roca9);
        });

        loaderGLTF.load("Models/roca6.glb", function (gltf) {
          //roca 10
          let roca10 = gltf.scene;
          roca10.scale.set(20.0, 20.0, 20.0);
          roca10.rotation.y = 0;
          roca10.position.set(150, 0, -109);
          scene.add(roca10);
        });

        loaderGLTF.load("Models/arbol1.glb", function (gltf) {
          //arbol 1
          let arbol1 = gltf.scene;
          arbol1.scale.set(5.0, 5.0, 5.0);
          arbol1.rotation.y = 0;
          arbol1.position.set(90, 0, 1);
          scene.add(arbol1);
        });

        loaderGLTF.load("Models/arbol1.glb", function (gltf) {
          //arbol 2
          let arbol2 = gltf.scene;
          arbol2.scale.set(5.0, 5.0, 5.0);
          arbol2.rotation.y = 0;
          arbol2.position.set(-80, 0, -9);
          scene.add(arbol2);
        });

        loaderGLTF.load("Models/arbol1.glb", function (gltf) {
          //arbol 3
          let arbol3 = gltf.scene;
          arbol3.scale.set(5.0, 5.0, 5.0);
          arbol3.rotation.y = 0;
          arbol3.position.set(40, 0, -129);
          scene.add(arbol3);
        });
      } else if (level == 3) {
        // Plane

        const planeGeometry = new THREE.PlaneGeometry(256, 256);
        const loader = new THREE.TextureLoader();

        const height = loader.load("track2.png");
        const track = loader.load("wasteLand.jpg");
        const planeMaterial = new THREE.MeshStandardMaterial({
          map: track,
          displacementMap: height,
        });

        const plane = new THREE.Mesh(planeGeometry, planeMaterial);
        plane.position.set(11, -0.5, -14);
        plane.receiveShadow = true;
        plane.rotateX(-Math.PI / 2);
        //plane.rotateZ(Math.PI);

        // Adding to scene
        scene.add(plane);

        loaderGLTF.load("Models/streetlamp.glb", function (gltf) {
          //streetlamp 1
          let streetlamp = gltf.scene;
          streetlamp.scale.set(0.1, 0.2, 0.1);
          streetlamp.rotation.y = 90;
          streetlamp.position.set(21, 0, -129);
          scene.add(streetlamp);
        });

        loaderGLTF.load("Models/streetlamp.glb", function (gltf) {
          //streetlamp 2
          let streetlamp = gltf.scene;
          streetlamp.scale.set(0.1, 0.2, 0.1);
          streetlamp.rotation.y = 0;
          streetlamp.position.set(21, 0, 96);
          scene.add(streetlamp);
        });

        loaderGLTF.load("Models/streetlamp.glb", function (gltf) {
          //streetlamp 3
          let streetlamp = gltf.scene;
          streetlamp.scale.set(0.1, 0.2, 0.1);
          streetlamp.rotation.y = 90;
          streetlamp.position.set(126, 0, -14);
          scene.add(streetlamp);
        });

        loaderGLTF.load("Models/streetlamp.glb", function (gltf) {
          //streetlamp 4
          let streetlamp = gltf.scene;
          streetlamp.scale.set(0.1, 0.2, 0.1);
          streetlamp.rotation.y = 225;
          streetlamp.position.set(-104, 0, -14);
          scene.add(streetlamp);
        });

        loaderGLTF.load("Models/barrel.glb", function (gltf) {
          //arbol

          let barrel = gltf.scene;
          barrel.scale.set(1.5, 1.5, 1.5);
          barrel.rotation.y = 0;
          barrel.position.set(-39, 2.5, 16);
          scene.add(barrel);
        });

        loaderGLTF.load("Models/barrel.glb", function (gltf) {
          //arbol

          let barrel2 = gltf.scene;
          barrel2.scale.set(1.5, 1.5, 1.5);
          barrel2.rotation.y = 0;
          barrel2.position.set(-19, 2.5, 6);
          scene.add(barrel2);
        });

        loaderGLTF.load("Models/barrel.glb", function (gltf) {
          //arbol

          let barrel3 = gltf.scene;
          barrel3.scale.set(1.5, 1.5, 1.5);
          barrel3.rotation.y = 0;
          barrel3.position.set(101, 2.5, -124);
          scene.add(barrel3);
        });

        loaderGLTF.load("Models/barrel.glb", function (gltf) {
          //arbol

          let barrel = gltf.scene;
          barrel.scale.set(1.5, 1.5, 1.5);
          barrel.rotation.x = 0;
          barrel.position.set(126, 2.5, -114);
          scene.add(barrel);
        });

        loaderGLTF.load("Models/barrel.glb", function (gltf) {
          //arbol

          let barrel2 = gltf.scene;
          barrel2.scale.set(1.5, 1.5, 1.5);
          barrel2.rotation.x = 1.5708;
          barrel2.position.set(121, 2.5, -134);
          scene.add(barrel2);
        });

        loaderGLTF.load("Models/barrel.glb", function (gltf) {
          //arbol

          let barrel3 = gltf.scene;
          barrel3.scale.set(1.5, 1.5, 1.5);
          barrel3.rotation.x = 1.5708;
          barrel3.position.set(-19, 2.5, 26);
          scene.add(barrel3);
        });

        loaderGLTF.load("Models/stopSign.glb", function (gltf) {
          //arbol 4
          let barrier = gltf.scene;
          barrier.scale.set(1.0, 1.0, 1.0);
          barrier.rotation.y = 0;
          barrier.position.set(86, 0, 31);
          scene.add(barrier);
        });

        loaderGLTF.load("Models/cone2.glb", function (gltf) {
          //arbol 5
          let cone = gltf.scene;
          cone.scale.set(1, 1, 1);
          cone.rotation.y = 0;
          cone.position.set(41, 0.5, 16);
          scene.add(cone);
        });

        loaderGLTF.load("Models/cone2.glb", function (gltf) {
          //arbol 5
          let cone = gltf.scene;
          cone.scale.set(1, 1, 1);
          cone.rotation.y = 0;
          cone.position.set(31, 0.5, 26);
          scene.add(cone);
        });

        loaderGLTF.load("Models/cone2.glb", function (gltf) {
          //arbol 5
          let cone = gltf.scene;
          cone.scale.set(1, 1, 1);
          cone.rotation.y = 0;
          cone.position.set(46, 0.5, 26);
          scene.add(cone);
        });

        loaderGLTF.load("Models/cone2.glb", function (gltf) {
          //arbol 5
          let cone = gltf.scene;
          cone.scale.set(1, 1, 1);
          cone.rotation.x = 1.5708;
          cone.position.set(81, 10, -84);
          scene.add(cone);
        });

        loaderGLTF.load("Models/cone2.glb", function (gltf) {
          //arbol 5
          let cone = gltf.scene;
          cone.scale.set(1, 1, 1);
          cone.rotation.y = 0;
          cone.position.set(71, 0.5, -94);
          scene.add(cone);
        });

        loaderGLTF.load("Models/cone2.glb", function (gltf) {
          //arbol 5
          let cone = gltf.scene;
          cone.scale.set(1, 1, 1);
          cone.rotation.y = 0;
          cone.position.set(61, 0.5, -94);
          scene.add(cone);
        });

        loaderGLTF.load("Models/cone2.glb", function (gltf) {
          //arbol 5
          let cone = gltf.scene;
          cone.scale.set(1, 1, 1);
          cone.rotation.x = 1.5708;
          cone.position.set(51, 10, -84);
          scene.add(cone);
        });

        loaderGLTF.load("Models/cone2.glb", function (gltf) {
          //arbol 5
          let cone = gltf.scene;
          cone.scale.set(1, 1, 1);
          cone.rotation.y = 0;
          cone.position.set(41, 0.5, -94);
          scene.add(cone);
        });

        loaderGLTF.load("Models/cone2.glb", function (gltf) {
          //arbol 5
          let cone = gltf.scene;
          cone.scale.set(1, 1, 1);
          cone.rotation.y = 0;
          cone.position.set(31, 0.5, -94);
          scene.add(cone);
        });
        loaderGLTF.load("Models/cone2.glb", function (gltf) {
          //arbol 5
          let cone = gltf.scene;
          cone.scale.set(1, 1, 1);
          cone.rotation.x = 1.5708;
          cone.position.set(21, 10, -84);
          scene.add(cone);
        });

        loaderGLTF.load("Models/cone2.glb", function (gltf) {
          //arbol 5
          let cone = gltf.scene;
          cone.scale.set(1, 1, 1);
          cone.rotation.y = 0;
          cone.position.set(11, 0.5, -94);
          scene.add(cone);
        });

        loaderGLTF.load("Models/cone2.glb", function (gltf) {
          //arbol 5
          let cone = gltf.scene;
          cone.scale.set(1, 1, 1);
          cone.rotation.x = 1.5708;
          cone.position.set(1, 10.0, -84);
          scene.add(cone);
        });

        loaderGLTF.load("Models/barrier.glb", function (gltf) {
          //streetlamp 1
          let barrier = gltf.scene;
          barrier.scale.set(5.0, 5.0, 5.0);
          barrier.position.set(1, 0, -4);
          barrier.rotation.y = 90;
          scene.add(barrier);
        });

        loaderGLTF.load("Models/barrier.glb", function (gltf) {
          //streetlamp 1
          let barrier = gltf.scene;
          barrier.scale.set(5.0, 5.0, 5.0);
          barrier.position.set(-89, 0, 86);
          barrier.rotation.y = 90;
          scene.add(barrier);
        });

        loaderGLTF.load("Models/barrier.glb", function (gltf) {
          //streetlamp 1
          let barrier = gltf.scene;
          barrier.scale.set(5.0, 5.0, 5.0);
          barrier.position.set(-49, 0, 86);
          barrier.rotation.y = 90;
          scene.add(barrier);
        });

        loaderGLTF.load("Models/barrier.glb", function (gltf) {
          //streetlamp 1
          let barrier = gltf.scene;
          barrier.scale.set(5.0, 5.0, 5.0);
          barrier.position.set(-79, 0, 46);
          barrier.rotation.y = 90;
          scene.add(barrier);
        });

        loaderGLTF.load("Models/tank.glb", function (gltf) {
          //streetlamp 1
          let tank = gltf.scene;
          tank.scale.set(20.0, 20.0, 20.0);
          tank.position.set(-74, 0, 76);
          tank.rotation.y = 0;
          scene.add(tank);
        });
      }

      let starReference;
      loaderGLTF.load("Models/star.glb", function (gltf) {
        //star
        let star = gltf.scene;
        starReference = star;
        star.scale.set(1, 1, 1);
        star.position.set(90, 4, 0);
        scene.add(star);
      });

      let ballReference;
      loaderGLTF.load("Models/BowlingBall.glb", function (gltf) {
        //bowlingBall
        let ball = gltf.scene;
        ballReference = ball;
        ball.scale.set(20, 20, 20);
        ball.position.set(95, 4, 40);
        scene.add(ball);
      });

      //Orientación de los autos
      let orientacion = "";
      let orientacionTaxi = 0;
      //Velocidad
      let vel = 0;
      let withBall = 0.1;
      let withStar = 0.3;
      //Objetos
      let starStatus = "";
      let starTiming = 0;
      let starTakedBy = "";

      let ballStatus = "";
      let ballTiming = 0;
      let ballTakedBy = "";

      //Anim
      let arriba = true;

      document.onkeydown = function (e) {
        //La Bestia
        //left
        if (e.keyCode === 37) {
          theBeastReference.rotation.y = 11;
          cube1.rotation.y = 0;
          orientacion = "izq";
        }
        //up
        if (e.keyCode === 38) {
          theBeastReference.rotation.y = 3.2;
          cube1.rotation.y = 4.75;
          orientacion = "arr";
        }
        //right
        if (e.keyCode === 39) {
          theBeastReference.rotation.y = 1.56;
          cube1.rotation.y = 0;
          orientacion = "der";
        }
        //down
        if (e.keyCode === 40) {
          theBeastReference.rotation.y = 0;
          cube1.rotation.y = 4.75;
          orientacion = "aba";
        }

        //taxi
        const oMesh = scene.getObjectByName(currentUser.uid);
        //left
        if (e.keyCode === 65) {
          oMesh.rotation.y += Math.PI / 2;
          cube2.rotation.y += Math.PI / 2;
          orientacionTaxi += 90;
          vel = 0.2;
          //a
        }
        //up
        if (e.keyCode === 87) {
          //taxiReference.rotation.y = 3.2;
          //cube2.rotation.y = 4.75;
          //orientacionTaxi = "w";
          vel = 0.2;

          if (musicOn() == "true") {
            playMusic();
            console.log("la música esta activa");
          } else {
            console.log("la música esta desactivada");
          }
        }
        //right
        if (e.keyCode === 68) {
          oMesh.rotation.y -= Math.PI / 2;
          cube2.rotation.y -= Math.PI / 2;
          orientacionTaxi -= 90;
          vel = 0.2;
          //d
        }
        //down
        if (e.keyCode === 83) {
          oMesh.rotation.y -= Math.PI;
          cube2.rotation.y -= Math.PI;
          orientacionTaxi -= 180;
          vel = 0.2;
          //s
        }
        //freno
        if (e.keyCode === 70) {
          orientacion = "f";
        }
        if (e.keyCode === 66) {
          //orientacionTaxi = 0;
          vel = 0;
          //b
        }
      };

      const cameraControl = new OrbitControls(camera, renderer.domElement);

      function checkCollisions() {
        if (cube2BB.intersectsBox(cube1BB)) {
          cube1.material.color = new THREE.Color("red");
        } else {
          cube1.material.color = new THREE.Color("aqua");
        }

        //Star
        if (cube1BB.intersectsBox(cube3BB)) {
          vel = withStar;
          starStatus = "taked";
          starTakedBy = "TheBeast";
          starSound.play();
        }
        if (cube2BB.intersectsBox(cube3BB)) {
          vel = withStar;
          starStatus = "taked";
          starTakedBy = "Taxi";
          starSound.play();
        }

        //Ball
        if (cube1BB.intersectsBox(cube4BB)) {
          vel = withBall;
          ballStatus = "taked";
          ballTakedBy = "TheBeast";
          ballSound.play();
        }
        if (cube2BB.intersectsBox(cube4BB)) {
          vel = withBall;
          ballStatus = "taked";
          ballTakedBy = "Taxi";
          ballSound.play();
        }
      }

      function movimiento() {
        //The Beast
        if (orientacion == "der") {
          theBeastReference.position.x += vel;
          cube1.position.x += vel;
        }
        if (orientacion == "izq") {
          theBeastReference.position.x -= vel;
          cube1.position.x -= vel;
        }
        if (orientacion == "arr") {
          theBeastReference.position.z -= vel;
          cube1.position.z -= vel;
        }
        if (orientacion == "aba") {
          theBeastReference.position.z += vel;
          cube1.position.z += vel;
        }

        //Taxi
        const oMesh = scene.getObjectByName(currentUser.uid);
        if (oMesh) {
          var orientacionTaxiMod = orientacionTaxi % 360;
          if (orientacionTaxiMod == 180 || orientacionTaxiMod == -180) {
            oMesh.position.x -= vel;
            cube2.position.x -= vel;
          }
          if (orientacionTaxiMod == 0) {
            oMesh.position.x += vel;
            cube2.position.x += vel;
          }
          if (orientacionTaxiMod == 90 || orientacionTaxiMod == -270) {
            oMesh.position.z -= vel;
            cube2.position.z -= vel;
          }
          if (orientacionTaxiMod == 270 || orientacionTaxiMod == -90) {
            oMesh.position.z += vel;
            cube2.position.z += vel;
          }
        }
      }

      // Resize

      function resize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.render(scene, camera);
      }

      window.addEventListener("resize", resize);

      function updateCamera() {
        const oMesh = scene.getObjectByName(currentUser.uid);
        if (oMesh) {
          followCam.parent = oMesh;
          camera.position.lerp(
            followCam.getWorldPosition(new THREE.Vector3()),
            0.03
          );
          camera.lookAt(oMesh.position);
        }
      }

      const db = getDatabase();
      const starCountRef = ref(db, "jugadores");
      onValue(starCountRef, (snapshot) => {
        const data = snapshot.val();
        //console.log(data);
        Object.entries(data).forEach(([key, value]) => {
          const jugador = scene.getObjectByName(key);
          if (!jugador) {
            if (value.model == 1) {
              let theBeastReference;
              const loaderGLTF = new GLTFLoader();
              loaderGLTF.load("Models/theBeast.glb", function (gltf) {
                theBeast = gltf.scene;
                theBeastReference = theBeast;
                theBeast.scale.set(2.5, 2.5, 2.5);
                theBeast.position.set(-5, 0, 68);
                theBeast.rotation.y = 1.56;
                theBeast.name = key;
                scene.add(theBeast);
              });
            } else if (value.model == 2) {
              let taxiReference;
              loaderGLTF.load("Models/taxi.glb", function (gltf) {
                taxi = gltf.scene;
                taxiReference = taxi;
                taxi.scale.set(1.0, 1.0, 1.0);
                taxi.position.set(-6, 0, 74);
                taxi.rotation.y = 1.56;
                taxi.name = key;
                scene.add(taxi);
              });
            } else if (value.model == 3) {
              let teslaReference;
              loaderGLTF.load("Models/teslaTruck.glb", function (gltf) {
                tesla = gltf.scene;
                teslaReference = tesla;
                tesla.scale.set(1.5, 1.5, 1.5);
                tesla.position.set(-6, 3.5, 80);
                tesla.rotation.y = 1.56;
                tesla.name = key;
                scene.add(tesla);
              });
            }
          }
          scene.getObjectByName(key).position.x = value.x;
          scene.getObjectByName(key).position.z = value.z;
          scene.getObjectByName(key).rotation.y = value.rotation;
        });
      });

      function writeUserData(userId, position, rotation, model) {
        const db = getDatabase();
        set(ref(db, "jugadores/" + userId), {
          x: position.x,
          z: position.z,
          rotation: rotation,
          model: model,
        });
      }

      function playMusic() {
        backgroundSound.play();
      }

      //Rotación de los objetos y desaparición
      function objectsAnimation() {
        starReference.rotation.y += 0.01;

        if (arriba == true) {
          starReference.position.y += 0.1;
          cube3.position.y += 0.1;
          if (starReference.position.y > 15) {
            arriba = false;
          }
        } else {
          starReference.position.y -= 0.1;
          cube3.position.y -= 0.1;
          if (starReference.position.y < 4) {
            arriba = true;
          }
        }

        if (starStatus == "taked") {
          if (starReference.position.y > -4) {
            starReference.position.y -= 0.2;
            cube3.position.y -= 0.5;
          }
        }

        if (ballReference) {
          ballReference.rotation.y += 0.01;
        }

        if (ballStatus == "taked") {
          if (ballReference.position.y > -4) {
            ballReference.position.y -= 0.2;
            cube4.position.y -= 0.5;
          }
        }
      }

      function animate() {
        cube2BB
          .copy(cube2.geometry.boundingBox)
          .applyMatrix4(cube2.matrixWorld);
        cube1BB
          .copy(cube1.geometry.boundingBox)
          .applyMatrix4(cube1.matrixWorld);
        checkCollisions();
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
        if (currentUser) {
          movimiento();
          updateCamera();
          const oMesh = scene.getObjectByName(currentUser.uid);
          writeUserData(
            currentUser.uid,
            { x: oMesh.position.x, z: oMesh.position.z },
            oMesh.rotation.y,
            mainModel
          );
        }
        if (starReference && ballReference) {
          objectsAnimation();
        }
      }

      window.onunload = function () {
        if (currentUser) {
          const dbRef = ref(db, "/jugadores/" + currentUser.uid);
          remove(dbRef).then(() => console.log("Deleted"));
        }
      };

      window.onbeforeunload = function () {
        if (currentUser) {
          const dbRef = ref(db, "/jugadores/" + currentUser.uid);
          remove(dbRef).then(() => console.log("Deleted"));
        }
      };

      animate();
    </script>
  </body>
</html>
